<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vytEcbSttusDAO">
	<!-- 타당성평가 전체현황 파이차트 -->
	<select id="selectEcbSttusTotCnt" resultType="egovMap">
		<![CDATA[
			SELECT '분석대기' AS NM,
				COALESCE(COUNT(*),0) AS CNT 
			FROM TN_FEIS_VYT_ECBSLDLIST A
			LEFT OUTER JOIN TN_FEIS_ANALFILE B ON A.MST_ID = B.MST_ID AND A.SLD_ID = CAST(B.SLD_ID AS INTEGER)
			WHERE (SELECT MAX(TO_CHAR(C.CREAT_DT,'YYYY')) FROM TN_FEIS_VYT_ECBSLDLIST C) = (SELECT MAX(TO_CHAR(D.CREAT_DT,'YYYY')) FROM TN_FEIS_ANALFILE D)
			AND B.ANAL_ID IS NULL
			UNION ALL
			SELECT 
				'분석완료' AS NM,
				COUNT(*) AS CNT
			FROM (
			SELECT MST_ID ,SLD_ID FROM TN_FEIS_ANALFILE
			WHERE TO_CHAR(CREAT_DT,'YYYY') = (SELECT MAX(TO_CHAR(CREAT_DT,'YYYY')) FROM TN_FEIS_VYT_ECBSLDLIST)
			GROUP BY MST_ID ,SLD_ID
			) E
		]]>
	</select>
	<!-- 타당성평가 지역별현황 막대차트-->
	<select id="selectEcbSttusRegion" resultType="egovMap">
		<![CDATA[			
			SELECT 
				CTPRVN_NM_ABRV AS NM
				, COALESCE(B.CNT,0) AS COMP
			FROM (
				SELECT CTPRVN_NM_ABRV,CTPRVN_COD
				FROM TF_FEIS_CTPRVN
				ORDER BY CTPRVN_NM
			) A
			LEFT OUTER JOIN (
				SELECT 
					SUBSTRING(C.LGSTR_CD,1,2) AS SIDO_CD
					, COUNT(*) AS CNT
				FROM TN_FEIS_VYT_ECBSLDLIST C
				LEFT OUTER JOIN 
				(
					SELECT 
						MST_ID ,SLD_ID
					FROM 
					(
						SELECT MST_ID ,SLD_ID FROM TN_FEIS_ANALFILE
						WHERE TO_CHAR(CREAT_DT,'YYYY') = (SELECT MAX(TO_CHAR(CREAT_DT,'YYYY')) FROM TN_FEIS_VYT_ECBSLDLIST)
						GROUP BY MST_ID ,SLD_ID
					) E
				) D ON C.MST_ID = D.MST_ID AND C.SLD_ID = CAST(D.SLD_ID AS INTEGER)
				WHERE D.MST_ID IS NOT NULL
				GROUP BY SUBSTRING(C.LGSTR_CD,1,2)
			) B ON A.CTPRVN_COD = B.SIDO_CD
		]]>
	</select>
	<!-- 외관점검조사 월별현황 막대차트-->
	<select id="selectEcbSttusMonth" resultType="egovMap">
		<![CDATA[
			SELECT A.MON AS MON, COALESCE(B.CNT,0) AS CNT
			FROM (
				SELECT SERIES AS MON 
				FROM GENERATE_SERIES(1,12) AS SERIES
			) A 
			LEFT OUTER JOIN (	
				SELECT 
						MON, COUNT(*) AS CNT
					FROM 
					(
						SELECT MST_ID ,SLD_ID,MAX(TO_CHAR(CREAT_DT,'MM')) AS MON FROM TN_FEIS_ANALFILE
						WHERE TO_CHAR(CREAT_DT,'YYYY') = (SELECT MAX(TO_CHAR(CREAT_DT,'YYYY')) FROM TN_FEIS_VYT_ECBSLDLIST)
						GROUP BY MST_ID ,SLD_ID
					) E
					GROUP BY MON
			) B ON A.MON::TEXT = B.MON::TEXT
			ORDER BY MON
		]]>
	</select>
</mapper>