<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="LssBscSvySttus">
	<!-- 기초조사 전체현황 파이차트 -->
	<select id="selectBscSvySttusTotCnt" resultType="egovMap" parameterType="egovMap">
		<![CDATA[	
			WITH T (MAX_DT) AS (
				SELECT MAX(DATE_PART('YEAR',CREAT_DT)) from TN_FEIS_BSC_FIELDINFO
			)	
			SELECT
				'조사대기' AS NM, ((#{popNo}::NUMERIC)-COUNT(*)) AS CNT
			FROM TN_FEIS_BSC_SVYMEMO, T
			WHERE SVYDT IS NOT NULL
			AND CREAT_DT >= TO_DATE(MAX_DT::TEXT||'-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS')
		 	AND CREAT_DT <= TO_DATE(MAX_DT::TEXT||'-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS')
			UNION ALL
			SELECT
				'조사완료' AS NM, COUNT(*) AS CNT
			FROM TN_FEIS_BSC_SVYMEMO, T
			WHERE SVYDT IS NOT NULL
			AND CREAT_DT >= TO_DATE(MAX_DT::TEXT||'-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS')
		 	AND CREAT_DT <= TO_DATE(MAX_DT::TEXT||'-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS')
		]]>	 
	</select>
	<!-- 기초조사 지역별현황 막대차트-->
	<select id="selectBscSvySttusRegion" resultType="egovMap">
		<![CDATA[
			WITH T (MAX_DT) AS (
				SELECT MAX(DATE_PART('YEAR',CREAT_DT)) from TN_FEIS_BSC_FIELDINFO
			)			
			SELECT 
			REGEXP_REPLACE(A.NM,'([^가-힣])*','','g') AS NM,
				COALESCE(C.CNT,0) AS COMP
			FROM (
				SELECT CODE_NM AS NM
				 FROM TN_FEIS_DETAILCODE 
				 WHERE CODE_ID = 'FEI001'
			) A 
			LEFT OUTER JOIN (	
				SELECT 
					REGEXP_REPLACE(REGION1,' ','','g') AS NM,
					COUNT(*) AS CNT
			 	FROM TN_FEIS_BSC_SVYMEMO, T
			 	WHERE REGION1 IS NOT NULL
			 	AND CREAT_DT >= TO_DATE(MAX_DT::TEXT||'-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS')
			 	AND CREAT_DT <= TO_DATE(MAX_DT::TEXT||'-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS')
			 	GROUP BY REGEXP_REPLACE(REGION1,' ','','g')
			) C ON A.NM = C.NM
		]]>
	</select>
	
	<select id="selectBscSvySttusMonth" resultType="egovMap">
		<![CDATA[
			WITH T (MAX_DT) AS (
				SELECT MAX(DATE_PART('YEAR',CREAT_DT)) from TN_FEIS_BSC_FIELDINFO
			)	
			SELECT A.MON AS MON, COALESCE(B.CNT,0) AS CNT
			FROM (
				SELECT SERIES AS MON 
				FROM GENERATE_SERIES(1,12) AS SERIES
			) A 
			LEFT OUTER JOIN (	
				SELECT 
					TO_CHAR(CREAT_DT,'MM')::INT AS MON,
					COUNT(*) AS CNT
			 	FROM TN_FEIS_BSC_SVYMEMO, T
			 	WHERE CREAT_DT >= TO_DATE(MAX_DT::TEXT||'-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS')
			 	AND CREAT_DT <= TO_DATE(MAX_DT::TEXT||'-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS')
			 	GROUP BY TO_CHAR(CREAT_DT,'MM')
			) B ON A.MON::TEXT = B.MON::TEXT
			ORDER BY MON
		]]>
	</select>
	
	<select id="selectBscSvyPopultnMember" resultType="int" parameterType="egovMap">	
		SELECT 
			COALESCE(MAX(POPULTN_CNT),0) 
		FROM TN_FEIS_BSC_SVYPOPULTN
		WHERE MBER_ID = #{mberId}
	</select>
	
	<insert id="insertBscSvyPopultn" parameterType="egovMap">
		INSERT INTO TN_FEIS_BSC_SVYPOPULTN
		(
			MBER_ID,
			POPULTN_CNT,
			CREAT_DT
		)
		VALUES
		(
			#{mber_id},
			#{popultn_cnt}::NUMERIC,
			now()
		)
		ON CONFLICT ON CONSTRAINT TN_FEIS_BSC_SVYPOPULTN_PKEY
	    DO UPDATE
		SET
			POPULTN_CNT = #{popultn_cnt}::NUMERIC
	</insert>
	
</mapper>