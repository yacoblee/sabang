<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="articleManageDAO">

	<resultMap id="articleList" type="or.sabang.mng.bbs.art.service.ArticleVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="rdcnt" column="RDCNT"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="sjBoldAt" column="SJ_BOLD_AT"/>
		<result property="noticeAt" column="NOTICE_AT"/>
		<result property="secretAt" column="SECRET_AT"/>
		<result property="commentCo" column="COMMENT_CO"/>
	</resultMap>
	
	<resultMap id="articleDetail" type="or.sabang.mng.bbs.art.service.ArticleVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>	
		<result property="ntcrId" column="NTCR_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="nttNo" column="NTT_NO"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="rdcnt" column="RDCNT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="bbsTyCode" column="BBS_TY_CODE"/>
		<result property="replyPosblAt" column="REPLY_POSBL_AT"/>
		<result property="fileAtchPosblAt" column="FILE_ATCH_POSBL_AT"/>
		<result property="posblAtchFileNumber" column="ATCH_POSBL_FILE_NUMBER"/>
		<result property="bbsNm" column="BBS_NM"/>
		<result property="sjBoldAt" column="SJ_BOLD_AT"/>
		<result property="noticeAt" column="NOTICE_AT"/>
		<result property="secretAt" column="SECRET_AT"/>
	</resultMap>
	
	<!-- 게시물 목록조회 -->
	<!-- SELECT
				a.NTT_ID, a.NTT_SJ, a.NTT_CN, a.FRST_REGISTER_ID, COALESCE(b.USER_NM, a.NTCR_NM) as FRST_REGISTER_NM,
				TO_CHAR(a.FRST_REGIST_PNTTM, 'YYYYmmdd') as FRST_REGIST_PNTTM,
				a.RDCNT, a.PARNTSCTT_NO, a.ANSWER_AT, a.ANSWER_LC, a.USE_AT, a.ATCH_FILE_ID,
				a.BBS_ID, a.NTCE_BGNDE, a.NTCE_ENDDE, a.SJ_BOLD_AT, a.NOTICE_AT, a.SECRET_AT, c.COMMENT_CO
			FROM
				TN_FEIS_BBS a	
			LEFT OUTER JOIN 
				COMVNUSERMASTER b
			ON a.FRST_REGISTER_ID = b.ESNTL_ID 
			LEFT OUTER JOIN
				(SELECT NTT_ID, BBS_ID, COUNT(1) AS COMMENT_CO 
				   FROM TN_FEIS_BBS_CM 
				 WHERE USE_AT = 'Y' 
				 GROUP BY NTT_ID, BBS_ID) c
			ON a.NTT_ID = c.NTT_ID
			AND a.BBS_ID = c.BBS_ID
			WHERE
				a.BBS_ID = #{bbsId}
			AND a.USE_AT = 'Y' -->
	<select id="selectArticleList" resultMap="articleList">
		<![CDATA[
			SELECT *
			FROM TN_FEIS_BBS 
			WHERE USE_AT = 'Y'
				AND BBS_ID = 'BBS_001'
		]]>
 		<if test="@egovframework.com.cmm.util.EgovMybaitsUtil@isNotEmpty(searchKeyword)">
 		<if test="searchCondition == 0">	<![CDATA[ AND 
 	             (NTT_SJ LIKE CONCAT ('%', #{searchKeyword},'%') OR 
 	             NTT_CN LIKE CONCAT ('%', #{searchKeyword},'%') OR 
 	             FRST_REGISTER_ID LIKE CONCAT ('%', #{searchKeyword},'%')) ]]>
 	        </if>
 	        <if test="searchCondition == 1">	<![CDATA[ AND 
 	             NTT_SJ LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
 	        </if>
 	        <if test="searchCondition == 2">	<![CDATA[ AND 
 	             NTT_CN LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
 	        </if>
 	        <if test="searchCondition == 3">	<![CDATA[ AND 
 	             FRST_REGISTER_ID LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
 	        </if>
         </if>
         ORDER BY SORT_ORDR DESC, FRST_REGIST_PNTTM DESC
 		LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>
	
	<!-- 게시물 갯수조회 -->
	<select id="selectArticleTotCnt" resultType="int">
		<![CDATA[
			SELECT
				COUNT(NTT_ID)
			FROM
				TN_FEIS_BBS 
			WHERE USE_AT = 'Y'
				AND BBS_ID = 'BBS_001'
		]]>
		<if test="@egovframework.com.cmm.util.EgovMybaitsUtil@isNotEmpty(searchKeyword)">
			<if test="searchCondition == 0">	<![CDATA[ AND
	             (NTT_SJ LIKE CONCAT ('%', #{searchKeyword},'%') OR
	             NTT_CN LIKE CONCAT ('%', #{searchKeyword},'%') OR 
	             FRST_REGISTER_ID LIKE CONCAT ('%', #{searchKeyword},'%')) ]]>
	        </if>
	        <if test="searchCondition == 1">	
	        	<![CDATA[ AND NTT_SJ LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
	        </if>
	        <if test="searchCondition == 2">	
	        	<![CDATA[ AND NTT_CN LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
	        </if>
	        <if test="searchCondition == 3">	
	        	<![CDATA[ AND FRST_REGISTER_ID LIKE CONCAT ('%', #{searchKeyword},'%') ]]>
	        </if>
        </if> 
	</select>
		
 	<!-- 게시물 조회수 증가 -->
	<update id="IncrsArticleRdcnt" parameterType="or.sabang.mng.bbs.art.service.ArticleVO">
			UPDATE TN_FEIS_BBS SET 
				RDCNT = RDCNT + 1 
			WHERE NTT_ID = #{nttId}
 	</update>
 	
	<!-- 게시물 상세조회 -->
	<select id="selectArticleDetail" resultMap="articleDetail">
		SELECT * 
		FROM TN_FEIS_BBS 
		WHERE ntt_id = #{nttId}
	</select>
	
	<!-- 게시물 등록 -->
	<insert id="insertArticle" parameterType="or.sabang.mng.bbs.art.service.ArticleVO">
		<![CDATA[
			INSERT INTO TN_FEIS_BBS
			(BBS_ID, 
				NTT_SJ, 
				NTT_CN,  
			 	USE_AT,
			 	ATCH_FILE_ID,
			 	FRST_REGISTER_ID,
			 	FRST_REGIST_PNTTM
			 )
			VALUES
			(#{bbsId}, 
				#{nttSj}, 
				#{nttCn},
				'Y',
				#{atchFileId},
			  	#{frstRegisterId}, 
			  	NOW()
			 ) 
		]]>
	</insert>
	
	<!-- 게시물 수정 -->
	<update id="updateArticle" parameterType="or.sabang.mng.bbs.art.service.ArticleVO">
			UPDATE TN_FEIS_BBS SET 
				NTT_SJ = #{nttSj},
				NTT_CN = #{nttCn}, 
				LAST_UPDUSR_ID = #{lastUpdusrId},
				LAST_UPDT_PNTTM = NOW()
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 	</update>
 	
 	<!-- 게시물 삭제 -->
	<update id="deleteArticle" parameterType="or.sabang.mng.bbs.art.service.ArticleVO">
			UPDATE TN_FEIS_BBS SET 
				USE_AT = 'N', 
				LAST_UPDUSR_ID = #{lastUpdusrId},
				LAST_UPDT_PNTTM = NOW()
			WHERE BBS_ID = #{bbsId}
			AND NTT_ID = #{nttId}
 	</update>
 	<select id="selectMainArticleList" resultType="egovMap" parameterType="hashMap">
 		SELECT *
			FROM TN_FEIS_BBS 
			WHERE USE_AT = 'Y'
				AND BBS_ID = 'BBS_001'
			ORDER BY NTT_ID DESC
			LIMIT 3
 	</select>
</mapper>