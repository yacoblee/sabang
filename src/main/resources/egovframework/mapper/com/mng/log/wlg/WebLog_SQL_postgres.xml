<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Wed May 11 15:50:41 KST 2016
	수정일                 수정자                          수정내용
  =========     =======    =================================================
 2017.09.19		이정은			날짜로 검색 시 '-'를 공백으로 변환, 로그삭제기한 210일 -> 6개월로 변경
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="WebLog">

	<!-- 웹로그 맵 -->	
	<resultMap id="WebLogVO" type="or.sabang.mng.log.wlg.service.WebLog">
		<result property="requstId" column="REQUST_ID"/>		
		<result property="occrrncDe" column="OCCRRNC_DE"/>
		<result property="url" column="URL"/>		
		<result property="rqesterIp" column="RQESTER_IP"/>		
		<result property="rqesterId" column="RQESTER_ID"/>
		<result property="rqsterNm" column="RQESTER_NM"/>			
	</resultMap>	

	<!-- 웹 로그 등록 -->
	<insert id="logInsertWebLog" parameterType="or.sabang.mng.log.wlg.service.WebLog">
		<![CDATA[
			INSERT INTO TH_FEIS_WEBLOG 
				( REQUST_ID
				  , URL
				  , RQESTER_ID
				  , RQESTER_IP
				  , OCCRRNC_DE )
			VALUES ( #{requstId}
				  , #{url}
				  , #{rqesterId}
				  , #{rqesterIp}
				  , NOW())
		]]>
	</insert>
	
	<!-- 웹 로그 상세 조회 -->
	<select id="selectWebLog" parameterType="or.sabang.mng.log.wlg.service.WebLog" resultMap="WebLogVO">
		<![CDATA[	
			SELECT 
				  a.REQUST_ID
				, TO_CHAR(a.OCCRRNC_DE,'YYYY-MM-DD HH24:MI:SS') AS OCCRRNC_DE
				, a.URL
				, a.RQESTER_IP
				, a.RQESTER_ID
				, b.MBER_NM AS RQESTER_NM
			FROM
				TH_FEIS_WEBLOG a
			LEFT OUTER JOIN TN_FEIS_GNRLMBER b
				ON a.RQESTER_ID = b.ESNTL_ID
			WHERE 
				a.REQUST_ID = #{requstId}
		]]>		
	</select>	
	
	<!-- 웹 로그 목록 조회 -->
	<select id="selectWebLogInf" parameterType="or.sabang.mng.log.wlg.service.WebLog" resultMap="WebLogVO">
			<![CDATA[
			SELECT 
				  a.REQUST_ID
				, TO_CHAR(a.OCCRRNC_DE,'YYYY-MM-DD HH24:MI:SS') AS OCCRRNC_DE
				, a.URL
				, a.RQESTER_IP
				, a.RQESTER_ID
				, b.MBER_NM AS RQESTER_NM
			FROM
				TH_FEIS_WEBLOG a
			LEFT OUTER JOIN TN_FEIS_GNRLMBER b
				ON a.RQESTER_ID = b.ESNTL_ID
			WHERE 
				1 = 1
			]]>	
				
			<if test="searchWrd != null and searchWrd != ''">
			<if test="searchCnd == 0">	<![CDATA[ AND
	             (LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 1">	<![CDATA[ AND
	             LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 2">	<![CDATA[ AND
	             (LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))) ]]>
	        </if>
	        <if test="searchCnd == 3">	<![CDATA[ AND
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%') ]]>
	        </if>
			</if>
			<if test="searchBgnDe != null and searchBgnDe != ''">	<![CDATA[	AND
					a.OCCRRNC_DE BETWEEN TO_TIMESTAMP(CONCAT(#{searchBgnDe},' 00:00:00'), 'YYYY-mm-dd HH24:MI:SS') 
														AND TO_TIMESTAMP(CONCAT(#{searchEndDe},' 23:59:59'), 'YYYY-mm-dd HH24:MI:SS')  ]]>	
			</if>		
			<![CDATA[	 ORDER BY a.OCCRRNC_DE DESC ]]>	
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
	</select>	
	
	<!-- 웹 로그 총건수 -->
	<select id="selectWebLogInfCnt" parameterType="or.sabang.mng.log.wlg.service.WebLog" resultType="int">
		 
		 <![CDATA[
			SELECT COUNT(a.REQUST_ID) as cnt
			FROM
				TH_FEIS_WEBLOG a
			LEFT OUTER JOIN TN_FEIS_GNRLMBER b
				ON a.RQESTER_ID = b.ESNTL_ID
			WHERE 
				1 = 1
			]]>		
			<if test="searchWrd != null and searchWrd != ''">
			<if test="searchCnd == 0">	<![CDATA[ AND
	             (LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 1">	<![CDATA[ AND
	             LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 2">	<![CDATA[ AND
	             (LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))) ]]>
	        </if>
	        <if test="searchCnd == 3">	<![CDATA[ AND
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%') ]]>
	        </if>
			</if>
			<if test="searchBgnDe != null and searchBgnDe != ''">	<![CDATA[	AND
				 	a.OCCRRNC_DE BETWEEN TO_TIMESTAMP(CONCAT(#{searchBgnDe},' 00:00:00'), 'YYYY-mm-dd HH24:MI:SS') 
														AND TO_TIMESTAMP(CONCAT(#{searchEndDe},' 23:59:59'), 'YYYY-mm-dd HH24:MI:SS')  ]]>	
			</if>
	</select>	
	
	<!-- 웹 로그 목록 엑셀 저장 -->
	<select id="selectWebLogExcel" parameterType="or.sabang.mng.log.wlg.service.WebLog" resultType="egovMap">
			<![CDATA[
			SELECT 
				  a.REQUST_ID
				, TO_CHAR(a.OCCRRNC_DE,'YYYY-MM-DD HH24:MI:SS') AS OCCRRNC_DE
				, a.URL
				, a.RQESTER_IP
				, a.RQESTER_ID
				, b.MBER_NM AS RQESTER_NM
			FROM
				TH_FEIS_WEBLOG a
			LEFT OUTER JOIN TN_FEIS_GNRLMBER b
				ON a.RQESTER_ID = b.ESNTL_ID
			WHERE 
				1 = 1
			]]>	
			<if test="searchWrd != null and searchWrd != ''">
			<if test="searchCnd == 0">	<![CDATA[ AND
	             (LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))
	             OR
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 1">	<![CDATA[ AND
	             LOWER(b.MBER_NM) LIKE LOWER(CONCAT ('%', #{searchWrd},'%')) ]]>
	        </if>
	        <if test="searchCnd == 2">	<![CDATA[ AND
	             (LOWER(a.URL) LIKE LOWER(CONCAT ('%', #{searchWrd},'%'))) ]]>
	        </if>
	        <if test="searchCnd == 3">	<![CDATA[ AND
	             a.RQESTER_IP LIKE CONCAT ('%', #{searchWrd},'%') ]]>
	        </if>	
			</if>
			<if test="searchBgnDe != null and searchBgnDe != ''">	<![CDATA[	AND
					a.OCCRRNC_DE BETWEEN TO_TIMESTAMP(CONCAT(#{searchBgnDe},' 00:00:00'), 'YYYYMMDD HH24:MI:SS') 
														AND TO_TIMESTAMP(CONCAT(#{searchEndDe},' 23:59:59'), 'YYYYMMDD HH24:MI:SS')  ]]>	
			</if>		
			<![CDATA[	 ORDER BY a.OCCRRNC_DE DESC ]]>	
	</select>
	
	<!-- 웹 로그 전날 로그 요약 등록 -->
	<insert id="logInsertWebLogSummary">
		<![CDATA[
			INSERT INTO TH_FEIS_WEBLOGSUMMARY 
			SELECT TO_CHAR(b.OCCRRNC_DE, 'YYYYmmdd' )
			     , b.URL
			     , COUNT(TO_CHAR(b.OCCRRNC_DE, 'YYYYmmdd' )) AS RDCNT
			  FROM TH_FEIS_WEBLOG b
			 WHERE NOT EXISTS (SELECT c.OCCRRNC_DE
			                     FROM TH_FEIS_WEBLOGSUMMARY c
			                    WHERE c.OCCRRNC_DE  = TO_CHAR(now() - interval '1 day', 'YYYYmmdd')
			                  )
			  AND TO_CHAR(b.OCCRRNC_DE, 'YYYYmmdd' ) = TO_CHAR(now() - interval '1 day', 'YYYYmmdd')
			 GROUP BY TO_CHAR(b.OCCRRNC_DE, 'YYYYmmdd' )
				    , b.URL
				  
		]]>
	</insert>
	
		<!-- 웹 로그 6개월전 로그 삭제 -->
	<delete id="logDeleteWebLogSummary">
		<![CDATA[
			DELETE FROM TH_FEIS_WEBLOG
			 WHERE TO_CHAR(OCCRRNC_DE, 'YYYYmmdd') <  TO_CHAR(now() - interval '6 month', 'YYYYmmdd')
				  
		]]>
	</delete>
	
</mapper>