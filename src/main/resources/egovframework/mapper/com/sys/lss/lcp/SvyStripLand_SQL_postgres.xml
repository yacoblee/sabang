<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lssLcpSvyStripLandDAO">

	<resultMap id="svySldDetailVO" type="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">
		<result property="gid" column="GID" /><!-- 고유아이디 -->
		<result property="sldId" column="SLD_ID" /><!-- 조사대상지방 아이디 -->
		<result property="rank" column="RANK" /><!-- 랭크번호 -->
		<result property="label" column="LABEL" /><!-- 라벨 -->
		<result property="addr" column="ADDR" /><!-- 주소 -->
		<result property="frtpCd" column="FRTP_CD" /><!-- 임상 -->
		<result property="mapLabel" column="MAP_LABEL" /><!-- 맵 라벨 -->
		<result property="lcpArea" column="LCP_AREA" /><!-- 면적 -->
		<result property="frtpArea" column="FRTP_AREA" /><!-- 편입면적 -->
		<result property="prrckLarg" column="PRRCK_LARG" /><!-- 지질(대) -->
		<result property="sldpAvg" column="SLDP_AVG" /><!-- 평균토심 -->
		<result property="sldpMin" column="SLDP_MIN" /><!-- 최소토심 -->
		<result property="sldpMax" column="SLDP_MAX" /><!-- 최대토심 -->
		<result property="sltpCd" column="SLTP_CD" /><!-- 토양형 -->
		<result property="sibflrScs" column="SIBFLR_SCS" /><!-- 토성 -->
		<result property="sibflrStr" column="SIBFLR_STR" /><!-- 토양구조 -->
		<result property="rockExdgr" column="ROCK_EXDGR" /><!-- 암노출도 -->
		<result property="sibflrCbs" column="SIBFLR_CBS" /><!-- 토양석력함량 -->
		<result property="wteffDgr" column="WTEFF_DGR" /><!-- 풍화정도 -->
	</resultMap>
	
	<!-- 조사대상지 등록정보 목록 조회 -->
	<select id="selectLssLcpSvySldList" resultType="egovMap">
		<![CDATA[
			SELECT ID
				, SVYSLD_NM
				, SVYSLD_CREATE_USER
				, CREAT_DT
				, SVYSLD_REGCNT
			FROM TN_FEIS_LCP_SVYSLDREGINFO
			WHERE 1 = 1
		]]>
		<if test="svysldNm != null and svysldNm != ''">	<![CDATA[ AND
			SVYSLD_NM LIKE CONCAT('%', #{svysldNm}, '%') ]]>
		</if>
		<if test="writer != null and writer != ''">	<![CDATA[ AND
			SVYSLD_CREATE_USER LIKE CONCAT('%', #{writer}, '%') ]]>
		</if>
		<![CDATA[
		 	ORDER BY LAST_UPDT_PNTTM DESC
		 	LIMIT  #{recordCountPerPage} OFFSET #{firstIndex}
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 목록 갯수조회 -->
	<select id="selectLssLcpSvySldTotCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM TN_FEIS_LCP_SVYSLDREGINFO
		]]>
	</select>
	
	<!-- 조사대상지 목록 상세조회 -->
	<select id="selectSvySldInfo" resultType="egovMap">
		<![CDATA[
			SELECT UNIQ_ID
				, SLD_ID
				, RANK
				, LABEL
				, ADDR
				, STDG_CD
				, FRTP_CD
				, PRRCK_LARG
			FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE 1 = 1
		]]> 
			<if test="id != null and id != ''">	<![CDATA[ AND
				SLD_ID = #{id} ]]>
			</if>
			<if test="rank != null and rank != ''">	<![CDATA[ AND
				RANK = #{rank}::NUMERIC ]]>
			</if>
			<if test="label != null and label != ''">	<![CDATA[ AND
				LABEL LIKE CONCAT('%', #{label}, '%') ]]>
			</if>
			<if test="sd != null and sd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 2) like CONCAT ('%', #{sd},'%') ]]>
			</if>
			<if test="sgg != null and sgg != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 5) like CONCAT ('%', #{sgg},'%') ]]>
			</if>
			<if test="emd != null and emd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 8) like CONCAT ('%', #{emd},'%') ]]>
			</if>
			<if test="ri != null and ri != ''">	<![CDATA[ AND
				STDG_CD like CONCAT ('%', #{ri},'%') ]]>
			</if>
			<if test="frtpCd != null and frtpCd != ''">	<![CDATA[ AND
				FRTP_CD = #{frtpCd} ]]>
			</if> 
			<if test="prrckLarg != null and prrckLarg != ''">	<![CDATA[ AND
				PRRCK_LARG = #{prrckLarg} ]]>
			</if>
		<![CDATA[ 
			LIMIT  #{recordCountPerPage} OFFSET #{firstIndex}
		]]>
	</select>
	
	<!-- 조사대상지 정보 갯수 조회 -->
	<select id="selectSvySldInfoCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE 1 = 1
		]]>
			<if test="id != null and id != ''">	<![CDATA[ AND
				SLD_ID = #{id} ]]>
			</if>
			<if test="rank != null and rank != ''">	<![CDATA[ AND
				RANK = #{rank}::NUMERIC ]]>
			</if>
			<if test="label != null and label != ''">	<![CDATA[ AND
				LABEL LIKE CONCAT('%', #{label}, '%') ]]>
			</if>
			<if test="sd != null and sd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 2) like CONCAT ('%', #{sd},'%') ]]>
			</if>
			<if test="sgg != null and sgg != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 5) like CONCAT ('%', #{sgg},'%') ]]>
			</if>
			<if test="emd != null and emd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 8) like CONCAT ('%', #{emd},'%') ]]>
			</if>
			<if test="ri != null and ri != ''">	<![CDATA[ AND
				STDG_CD like CONCAT ('%', #{ri},'%') ]]>
			</if>
			<if test="frtpCd != null and frtpCd != ''">	<![CDATA[ AND
				FRTP_CD = #{frtpCd} ]]>
			</if> 
			<if test="prrckLarg != null and prrckLarg != ''">	<![CDATA[ AND
				PRRCK_LARG = #{prrckLarg} ]]>
			</if>
	</select>
	
	<!-- 조사대상지 정보 상세조회 -->
	<select id="selectSvySldInfoDetail" parameterType="java.util.Map" resultMap="svySldDetailVO">
		<![CDATA[
			SELECT *
			FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE SLD_ID = #{sldId} 
				AND UNIQ_ID = #{uniqId}
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 중복체크 -->
	<select id="dplctCheckSvySldInfo" parameterType="hashMap" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM TN_FEIS_LCP_SVYSLDREGINFO
			WHERE TO_CHAR(CREAT_DT, 'YYYY') = #{svysldYear} 
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 등록 -->
	<insert id="insertSvySldRegInfo" parameterType="hashMap" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			INSERT INTO TN_FEIS_LCP_SVYSLDREGINFO( SVYSLD_NM
				, SVYSLD_CREATE_USER
				, SVYSLD_ADMIN_USER
				, SVYSLD_REGCNT
			)
			VALUES( #{svysldNm}
				, #{svysldCreateUser}
				, #{svysldAdminUser}
				, #{svysldRegcnt}::NUMERIC		
			)
		]]>
	</insert>
	
	<!-- 땅밀림 실태조사 8개 시도 조회 -->
	<select id="selectRankInfo" resultType="egovMap">
		<![CDATA[
			SELECT SMID
				, RANK
				, UNIQ_ID
				, STDG_CD
				, CONCAT(STDG_NM, ' ', LNM_LCGR) AS ADDR
			FROM TF_FEIS_LCP_RANK
		]]>
		WHERE SVY_YEAR IS NULL	
		<if test="sdCd == '41'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '11%'
					OR STDG_CD LIKE '28%')
			]]>
		</if>
		<if test="sdCd == '43'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '36%')
			]]>
		</if>
		<if test="sdCd == '44'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '30%')
			]]>
		</if>
		<if test="sdCd == '47'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '27%')
			]]>
		</if>
		<if test="sdCd == '46'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '29%')
			]]>
		</if>
		<if test="sdCd == '48'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '26%'
					OR STDG_CD LIKE '31%')
			]]>
		</if>
		<if test="sdCd == '51' or sdCd == '45'">
			<![CDATA[ 
				AND STDG_CD LIKE CONCAT(#{sdCd},'%')
			]]> 
		</if>
		<![CDATA[
			ORDER BY RANK ASC
		]]>
		<if test="sdCnt != null and sdCnt != ''">
			<![CDATA[ 
				LIMIT #{sdCnt}::NUMERIC
			]]>
		</if>
	</select>
	
	<!-- 땅밀림 실태조사 8개 시도 미조사 건수 조회 -->
	<select id="selectRankInfoCnt" resultType="egovMap">
		<![CDATA[
			SELECT DISTINCT (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('41%') OR STDG_CD LIKE '11%' OR STDG_CD LIKE '28%')) AS "1"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('43%') OR STDG_CD LIKE '36%')) AS "2"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('44%') OR STDG_CD LIKE '30%')) AS "3"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('45%') OR STDG_CD LIKE '27%')) AS "4"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('46%') OR STDG_CD LIKE '26%' OR STDG_CD LIKE '31%')) AS "5"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND STDG_CD LIKE CONCAT('47%')) AS "6"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND ( STDG_CD LIKE CONCAT('48%') OR STDG_CD LIKE '29%')) AS "7"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR IS null AND STDG_CD LIKE CONCAT('51%')) AS "8"
			FROM TF_FEIS_LCP_RANK
		]]>
	</select>
	
	<!-- 땅밀림 실태조사 8개 시도 작년조사 건수 조회 -->
	<select id="selectLastRankInfoCnt" resultType="egovMap">
		<![CDATA[
			SELECT DISTINCT (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('41%') OR STDG_CD LIKE '11%' OR STDG_CD LIKE '28%')) AS "1"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('43%') OR STDG_CD LIKE '36%')) AS "2"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('44%') OR STDG_CD LIKE '30%')) AS "3"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('45%') OR STDG_CD LIKE '27%')) AS "4"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('46%') OR STDG_CD LIKE '26%' OR STDG_CD LIKE '31%')) AS "5"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND STDG_CD LIKE CONCAT('47%')) AS "6"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND ( STDG_CD LIKE CONCAT('48%') OR STDG_CD LIKE '29%')) AS "7"
				, (SELECT count(*) FROM TF_FEIS_LCP_RANK WHERE SVY_YEAR = (SELECT EXTRACT(YEAR FROM (CURRENT_TIMESTAMP + '-1YEAR'))::TEXT) AND STDG_CD LIKE CONCAT('51%')) AS "8"
			FROM TF_FEIS_LCP_RANK
		]]>
	</select>
	
	<!-- 랭크데이터 수정 -->
	<update id="updateRankInfo" parameterType="hashMap">
		<![CDATA[
			UPDATE TF_FEIS_LCP_RANK
				SET SVY_YEAR = #{year}
					, SLD_ID = #{sldId}
			WHERE SMID IN(
				SELECT SMID
				FROM TF_FEIS_LCP_RANK
				WHERE SVY_YEAR IS NULL
		]]>
			<if test="sdCd == '41'">
			<![CDATA[ 
				AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
					OR STDG_CD LIKE '11%'
					OR STDG_CD LIKE '28%')
				]]>
			</if>
			<if test="sdCd == '43'">
				<![CDATA[ 
					AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
						OR STDG_CD LIKE '36%')
				]]>
			</if>
			<if test="sdCd == '44'">
				<![CDATA[ 
					AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
						OR STDG_CD LIKE '30%')
				]]>
			</if>
			<if test="sdCd == '47'">
				<![CDATA[ 
					AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
						OR STDG_CD LIKE '27%')
				]]>
			</if>
			<if test="sdCd == '46'">
				<![CDATA[ 
					AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
						OR STDG_CD LIKE '29%')
				]]>
			</if>
			<if test="sdCd == '48'">
				<![CDATA[ 
					AND ( STDG_CD LIKE CONCAT(#{sdCd},'%')
						OR STDG_CD LIKE '26%'
						OR STDG_CD LIKE '31%')
				]]>
			</if>
			<if test="sdCd == '51' or sdCd == '45'">
				<![CDATA[ 
					AND STDG_CD LIKE CONCAT(#{sdCd},'%')
				]]> 
			</if>
			<![CDATA[
				ORDER BY RANK ASC
			]]>
			<if test="sdCnt != null and sdCnt != ''">
				<![CDATA[ 
					LIMIT #{sdCnt}::NUMERIC
				]]>
			</if>
			)
	</update>
	
	<!-- 조사대상지 조사지 개수 정보 조회 -->
	<select id="selectSvySldCntInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="egovMap">
		SELECT (SELECT COUNT(*)+1 FROM TN_FEIS_LCP_SVYSLDINFO WHERE CTRD_CD = #{ctrdCd} AND UNIQ_ID LIKE 'RANK%' AND SLD_ID = #{sldId}) AS GID
			, COALESCE(MAX( CASE WHEN (LENGTH(#{label}) - LENGTH(REPLACE(#{label},'-',''))) = 1 THEN (SELECT COUNT(*) + 1 FROM TN_FEIS_LCP_SVYSLDINFO WHERE CTRD_CD = #{ctrdCd} AND UNIQ_ID LIKE 'RANK%' AND SLD_ID = #{sldId}) 
				ELSE (SELECT COUNT(*)+1 FROM TN_FEIS_LCP_SVYSLDINFO WHERE CTRD_CD = #{ctrdCd} AND UNIQ_ID LIKE 'RANK%' AND SPLIT_PART(LABEL,'-',3) != '' AND SLD_ID = #{sldId})
			END),#{labelNum}::NUMERIC) AS LABEL_NUM
		FROM TN_FEIS_LCP_SVYSLDINFO
	</select>
	
	<!-- 조사대상지 정보 등록 -->
	<update id="insertSvySldInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">		
		<![CDATA[
			INSERT INTO TN_FEIS_LCP_SVYSLDINFO( SLD_ID
				, RANK
				, UNIQ_ID
				, CTRD_CD
				, STDG_CD
				, LABEL
				, ADDR
				, FRTP_CD
				, PRRCK_LARG
				, PRRCK_MDDL
				, SLTP_CD
				, SIBFLR_SCS
				, SIBFLR_STR
				, ROCK_EXDGR
				, SIBFLR_CBS
				, WTEFF_DGR
			)
			VALUES( #{sldId}
				, #{rank}::NUMERIC
				, #{uniqId}
				, #{ctrdCd}
				, #{stdgCd}
				, CONCAT(#{label}, #{labelNum})
				, #{addr}
				, #{frtpCd}
				, #{prrckLarg}
				, #{prrckMddl}		
				, #{sltpCd}		
				, #{sibflrScs}		
				, #{sibflrStr}		
				, #{rockExdgr}		
				, #{sibflrCbs}		
				, #{wteffDgr}		
			)
		]]>
	</update>
	
	<!-- 조사대상지 등록정보 상세조회 -->
	<select id="selectSvySldRegInfoDetail" resultType="egovMap">
		<![CDATA[
			SELECT *
			FROM TN_FEIS_LCP_SVYSLDREGINFO
			WHERE ID = #{id}::NUMERIC	
		]]>
	</select>
	
	<!-- 조사대상지 시도별 건수 조회 -->
	<select id="selectSvySldCtrdCnt" resultType="egovMap">
		<![CDATA[
			SELECT
				CTRD_CD,CTRD_CNT
			FROM(
				SELECT '41' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD IN('11','28','41')
				UNION
				SELECT '43' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD IN('36','43')
				UNION
				SELECT '44' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD IN('30','44')
				UNION
				SELECT '46' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD IN('29','46')
				UNION
				SELECT '47' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD IN('27','47')
				UNION
				SELECT '48' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}		
				AND CTRD_CD IN('26','31','48')
				UNION
				SELECT '51' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}
				AND CTRD_CD = '51'	
				UNION
				SELECT '45' AS CTRD_CD,
					COUNT(CTRD_CD) AS CTRD_CNT 
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE SLD_ID = #{sldId}			
				AND CTRD_CD = '45'					
			) AS A
			ORDER BY CTRD_CD ASC
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 수정 -->
	<update id="updateSvySldRegInfo">
		<![CDATA[
			UPDATE TN_FEIS_LCP_SVYSLDREGINFO
			SET LAST_UPDT_PNTTM = NOW()
				, SVYSLD_REGCNT = (SELECT COUNT(*) FROM TN_FEIS_LCP_SVYSLDINFO WHERE SLD_ID = #{sldId} )
			WHERE ID = #{sldId}::NUMERIC
		]]>
	</update>
	
	<!-- 조사대상지 정보 삭제 -->
	<delete id="deleteSvySldInfo">
		<![CDATA[
			DELETE FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE UNIQ_ID IN(
				SELECT UNIQ_ID
				FROM TN_FEIS_LCP_SVYSLDINFO
				WHERE 1 = 1
		]]>
		<if test="sdCd != null and sdCd !=''">
		<![CDATA[ 
			AND CTRD_CD = #{sdCd}
			]]>
		</if>
		<if test="id != null and id !=''">
		<![CDATA[ 
			AND SLD_ID = #{id}
			]]>
		</if>
		<![CDATA[
			ORDER BY GID DESC
		]]>
		<if test="sdCnt != null and sdCnt != ''">
			<![CDATA[ 
				LIMIT #{sdCnt}::NUMERIC
			]]>
		</if>
		)
	</delete>
	
	<!-- 랭크데이터 수정 -->
	<update id="updateRankDelInfo" parameterType="hashMap">
		<![CDATA[
			UPDATE TF_FEIS_LCP_RANK
				SET SVY_YEAR = NULL
					, SLD_ID = NULL
				WHERE UNIQ_ID IN(
					SELECT UNIQ_ID
					FROM TN_FEIS_LCP_SVYSLDINFO
					WHERE 1 = 1
			]]>
			<if test="sdCd != null and sdCd !=''">
			<![CDATA[ 
				AND CTRD_CD = #{sdCd}
				]]>
			</if>
			<if test="id != null and id !=''">
			<![CDATA[ 
				AND SLD_ID = #{id}
				]]>
			</if>
			<![CDATA[
				ORDER BY GID DESC
			]]>
			<if test="sdCnt != null and sdCnt != ''">
				<![CDATA[ 
					LIMIT #{sdCnt}::NUMERIC
				]]>
			</if>
			)
	</update>
	
	
	<!-- 조사대상지 임상도 조회  -->
	<select id="selectSvySldImInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">
		<![CDATA[
			SELECT *
			FROM(
				SELECT MAX(ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY))) FRTP_AREA
					, A.RANK 
					, B.FRTP_CD
					, ST_AREA(A.SMGEOMETRY) LCP_AREA
					, DENSE_RANK() OVER (ORDER BY ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY)) DESC) AS RNK
				FROM TF_FEIS_LCP_RANK A, TF_FEIS_IM5000 B
				WHERE A.RANK = #{rank}::NUMERIC
					AND ST_INTERSECTS(A.SMGEOMETRY,B.SMGEOMETRY) 
				GROUP BY A.SMGEOMETRY , B.SMGEOMETRY , A.RANK ,B.FRTP_CD 
			) T 
			WHERE RNK = 1
		]]>
	</select>
	
	<!-- 조사대상지 입지도 조회  -->
	<select id="selectSvySldIjInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">
		<![CDATA[
			SELECT * 
			FROM(
				SELECT A.RANK
					, B.SLTP_CD 
					, B.SIBFLR_SCS 
					, B.SIBFLR_STR 
					, B.ROCK_EXDGR 
					, B.SIBFLR_CBS 
					, B.WTEFF_DGR 
					, ST_AREA(A.SMGEOMETRY) LCP_AREA
					, MAX(ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY))) FRTP_AREA
					, DENSE_RANK() OVER (ORDER BY ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY)) DESC) AS RNK
				FROM TF_FEIS_LCP_RANK A, TF_FEIS_IJ100 B
				WHERE A.RANK = #{rank}::NUMERIC
					AND ST_INTERSECTS(A.SMGEOMETRY,B.SMGEOMETRY) 
				GROUP BY A.SMGEOMETRY , B.SMGEOMETRY , A.RANK
					, B.SLTP_CD , B.SIBFLR_SCS , B.SIAFLR_STR , B.SIBFLR_STR , B.ROCK_EXDGR , B.SIBFLR_CBS , B.WTEFF_DGR
			) T 
			WHERE RNK = 1
		]]>
	</select>

	<!-- 조사대상지 지질도 조회  -->
	<select id="selectSvySldGlInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">
		<![CDATA[
			SELECT *
			FROM(
				SELECT MAX(ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY))) FRTP_AREA
					, A.RANK 
					, B.PRRCK_LARG
					, B.PRRCK_MDDL
					, ST_AREA(A.SMGEOMETRY) LCP_AREA
					, DENSE_RANK() OVER (ORDER BY ST_AREA(ST_INTERSECTION(A.SMGEOMETRY,B.SMGEOMETRY)) DESC) AS RNK
				FROM TF_FEIS_LCP_RANK A, TF_FEIS_IJ5000 B
				WHERE A.RANK = #{rank}::NUMERIC
					AND ST_INTERSECTS(A.SMGEOMETRY,B.SMGEOMETRY) 
				GROUP BY A.SMGEOMETRY , B.SMGEOMETRY , A.RANK , B.PRRCK_LARG , B.PRRCK_MDDL 
			) T 
			WHERE RNK = 1
		]]>
	</select>
	
	<!-- 랭크 정보 삭제 -->
	<update id="deleteRank">
		<![CDATA[
			UPDATE TF_FEIS_LCP_RANK
				SET SVY_YEAR = NULL
					, SLD_ID = NULL
			WHERE SLD_ID = #{id}
		]]>
	</update>
	
	<!-- 제보 정보 삭제 -->
	<update id="deleteGvf">
		<![CDATA[
			DELETE FROM TF_FEIS_LCP_GVF				
			WHERE SLD_ID = #{id}
		]]>
	</update>
	
	<!-- 조사대상지 등록정보 삭제 -->
	<delete id="deleteSvySldRegInfo">
		<![CDATA[
			DELETE FROM TN_FEIS_LCP_SVYSLDREGINFO
			WHERE ID = #{id}::NUMERIC
		]]>
	</delete>
	
	<update id="updateSvySldElevInfo" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";" open="" close="">
			UPDATE TN_FEIS_LCP_SVYSLDINFO
				SET EVT_MIN = #{item.zonalMin}
				, EVT_MAX = #{item.zonalMax}
				, EVT_AVG = #{item.zonalMean}
			WHERE UNIQ_ID = #{item.uniqId}
		</foreach>
	</update>
	
	<update id="updateSvySldSlopInfo" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";" open="" close="">
			UPDATE TN_FEIS_LCP_SVYSLDINFO
				SET SLP_MIN = #{item.zonalMin}
				, SLP_MAX = #{item.zonalMax}
				, SLP_AVG = #{item.zonalMean}
			WHERE UNIQ_ID = #{item.uniqId}
		</foreach>
	</update>
	
	<update id="updateSvySldSldInfo" parameterType="java.util.List">
		<foreach collection="list" item="item" separator=";" open="" close="">
			UPDATE TN_FEIS_LCP_SVYSLDINFO
				SET SLDP_MIN = #{item.zonalMin}
				, SLDP_MAX = #{item.zonalMax}
				, SLDP_AVG = #{item.zonalMean}
			WHERE UNIQ_ID = #{item.uniqId}
		</foreach>
	</update>
	
	<!-- 조사대상지 등록정보방 목록 조회 -->
	<select id="selectSvySldRegInfoList" resultType="egovMap">
		<![CDATA[
			SELECT ID
				, SVYSLD_NM
			FROM TN_FEIS_LCP_SVYSLDREGINFO
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 목록 갯수조회 -->
	<select id="test" resultType="egovMap">
		<![CDATA[
			SELECT rank
			FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE UNIQ_ID LIKE 'RANK%'
		]]>
	</select>
	
	<!-- 조사대상지 등록정보 목록 갯수조회 -->
	<select id="selectSvysldGidInfo" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="egovMap">
		<![CDATA[
			SELECT * FROM TN_FEIS_LCP_SVYSLDINFO 
			WHERE CTRD_CD = #{ctrdCd} 
				AND UNIQ_ID LIKE 'RANK%' 
				AND SPLIT_PART(LABEL,'-',3) = '' 
			ORDER BY SPLIT_PART(LABEL,'-',2)::NUMERIC ASC
		]]>
	</select>
	
	<update id="updateSvySldGid" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO">
		UPDATE TN_FEIS_LCP_SVYSLDINFO
			SET GID = #{gid}::NUMERIC
		WHERE UNIQ_ID = #{uniqId}
	</update>
	
	<!-- 대상지 엑셀다운로드  -->
	<select id="selectLcpSvySldListExcel" parameterType="or.sabang.sys.lss.lcp.service.LssLcpSvyStripLandVO" resultType="egovMap">
		<![CDATA[
			SELECT 
				RANK
				, LABEL
				, STDG_CD
				, ADDR
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI071' AND CODE = FRTP_CD) AS FRTP_CD
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI072' AND CODE = PRRCK_LARG) AS PRRCK_LARG
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI073' AND CODE = PRRCK_MDDL) AS PRRCK_MDDL
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI074' AND CODE = SLTP_CD) AS SLTP_CD
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI075' AND CODE = SIBFLR_SCS) AS SIBFLR_SCS
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI076' AND CODE = SIBFLR_STR) AS SIBFLR_STR
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI077' AND CODE = ROCK_EXDGR) AS ROCK_EXDGR
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI078' AND CODE = SIBFLR_CBS) AS SIBFLR_CBS
				, (SELECT CODE_DC FROM TN_FEIS_DETAILCODE WHERE CODE_ID = 'FEI079' AND CODE = WTEFF_DGR) AS WTEFF_DGR
				, SLDP_AVG
				, SLDP_MIN
				, SLDP_MAX
				, EVT_AVG
				, EVT_MIN
				, EVT_MAX
				, SLP_AVG
				, SLP_MIN
				, SLP_MAX
			FROM TN_FEIS_LCP_SVYSLDINFO
			WHERE 1 = 1
			]]>
			<if test="id != null and id != ''">	<![CDATA[ AND
				SLD_ID = #{id} ]]>
			</if>
			<if test="rank != null and rank != ''">	<![CDATA[ AND
				RANK = #{rank}::NUMERIC ]]>
			</if>
			<if test="label != null and label != ''">	<![CDATA[ AND
				LABEL LIKE CONCAT('%', #{label}, '%') ]]>
			</if>
			<if test="sd != null and sd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 2) like CONCAT ('%', #{sd},'%') ]]>
			</if>
			<if test="sgg != null and sgg != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 5) like CONCAT ('%', #{sgg},'%') ]]>
			</if>
			<if test="emd != null and emd != ''">	<![CDATA[ AND
				SUBSTRING(STDG_CD, 1, 8) like CONCAT ('%', #{emd},'%') ]]>
			</if>
			<if test="ri != null and ri != ''">	<![CDATA[ AND
				STDG_CD like CONCAT ('%', #{ri},'%') ]]>
			</if>
			<if test="frtpCd != null and frtpCd != ''">	<![CDATA[ AND
				FRTP_CD = #{frtpCd} ]]>
			</if> 
			<if test="prrckLarg != null and prrckLarg != ''">	<![CDATA[ AND
				PRRCK_LARG = #{prrckLarg} ]]>
			</if>
		<![CDATA[
			ORDER BY NULLIF(REGEXP_REPLACE(LABEL ,'[0-9]','','g'),''),NULLIF(REGEXP_REPLACE(LABEL ,'[^0-9]','','g'),'')::INT
		]]>
	</select>
</mapper>