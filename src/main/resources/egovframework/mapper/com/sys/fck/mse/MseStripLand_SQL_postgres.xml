<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fckMseStripLandDAO">
	
	<resultMap id="mseStripLandDetailVO" type="or.sabang.sys.fck.mse.service.FckMseStripLandVO">
		<result property="sldId" column="SLD_ID" /> <!--조사ID-->
		<result property="svySd" column="SD" /> <!--시도명-->
		<result property="svySgg" column="SGG" /> <!--시군구명-->
		<result property="svyEmd" column="EMD" /> <!--읍면동명-->
		<result property="svyRi" column="RI" /> <!--리명-->
		<result property="svyJibun" column="JIBUN" /> <!--지번-->
		<result property="owner" column="OWNER" /> <!--지번-->
		<result property="lglLimit" column="LGL_LIMIT" /> <!--지번-->
		
		<!-- 공통 -->
		<result property="twEn" column="TW_EN" /> <!-- 와이어신축계 유무 -->
		<result property="incEn" column="INC_EN" /> <!-- 지중경사계 유무 -->
		<result property="wlEn" column="WL_EN" /> <!-- 지하수위계 유무 -->
		<result property="rgEn" column="RG_EN" /> <!-- 강우계 유무 -->
		<result property="tmEn" column="TM_EN" /> <!-- 구조물변위계 유무 -->
		<result property="sdEn" column="SD_EN" /> <!-- 지표변위계 유무 -->
		<result property="gpsEn" column="GPS_EN" /> <!-- GPS변위계 유무 -->
		<result property="gatewayEn" column="GATEWAY_EN" /> <!-- 게이트웨이 유무 -->
		<result property="nodeEn" column="NODE_EN" /> <!-- 노드 유무 -->
		
		<result property="wireExt" column="WIRE_EXT" /> <!-- 와이어신축계 -->
		<result property="licMeter" column="LIC_METER" /> <!-- 지중경사계 -->
		<result property="licCnt" column="LIC_CNT" /> <!-- 지중경사계 채널 개수 -->
		<result property="licMeterCnt" column="LIC_METER_CNT" /> <!-- 지중경사계 성능점검 개수 -->
		<result property="gwGauge" column="GW_GAUGE" /> <!-- 지하수위계 -->
		<result property="rainGauge" column="RAIN_GAUGE" /> <!-- 강우계 -->
		<result property="strcDpm" column="STRC_DPM" /> <!-- 구조물변위계 -->
		<result property="surDpm" column="SUR_DPM" /> <!-- 지표변위계 -->
		<result property="gpsGauge" column="GPS_GAUGE" /> <!-- GPS변위계 -->
		<result property="gateway" column="GATEWAY" /> <!-- 게이트웨이 -->
		<result property="gatewayId" column="GATEWAY_ID" /> <!-- 게이트웨이 ID -->
		<result property="node" column="NODE" /> <!-- 노드 -->
		<result property="modemNum" column="MODEM_NUM" /> <!-- 통신모뎀번호 -->
		<result property="cellNum" column="CELL_NUM" /> <!-- 이동전화번호 -->
	
		
	</resultMap>
	
	<!-- 대상지 등록정보 목록 조회 -->
	<select id="selectFckMseSldList" resultType="egovMap">
		<![CDATA[
			SELECT ID 
				, SLD_ID
				, SD
				, SGG
				, EMD
				, RI
				, JIBUN
			FROM TN_FEIS_MSE_SLDINFO
			WHERE 1 = 1
		]]>
		<if test="sldId != null and sldId != ''">	<![CDATA[ AND
			SLD_ID LIKE CONCAT('%', #{sldId}, '%') ]]>
		</if>
		<if test="svySd != null and svySd != ''">	<![CDATA[ AND
			SD = #{svySd} ]]>
		</if>
		<if test="svySgg != null and svySgg != ''">	<![CDATA[ AND
			SGG = #{svySgg} ]]>
		</if>
		<if test="svyEmd != null and svyEmd != ''">	<![CDATA[ AND
			EMD = #{svyEmd} ]]>
		</if>
		<if test="svyRi != null and svyRi != ''">	<![CDATA[ AND
			RI = #{svyRi} ]]>
		</if>
		<if test="svyJibun != null and svyJibun != ''">	<![CDATA[ AND
			JIBUN LIKE CONCAT('%', #{svyJibun}, '%') ]]>
		</if>
		<![CDATA[
		 	ORDER BY ID ASC
		 	LIMIT  #{recordCountPerPage} OFFSET #{firstIndex}
		]]>
	</select>
	
	<!-- 대상지 등록정보 목록 갯수조회 -->
	<select id="selectFckMseSldTotCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*)
			FROM TN_FEIS_MSE_SLDINFO
			WHERE 1 = 1
		]]>
		<if test="sldId != null and sldId != ''">	<![CDATA[ AND
			SLD_ID LIKE CONCAT('%', #{sldId}, '%') ]]>
		</if>
		<if test="svySd != null and svySd != ''">	<![CDATA[ AND
			SD = #{svySd} ]]>
		</if>
		<if test="svySgg != null and svySgg != ''">	<![CDATA[ AND
			SGG = #{svySgg} ]]>
		</if>
		<if test="svyEmd != null and svyEmd != ''">	<![CDATA[ AND
			EMD = #{svyEmd} ]]>
		</if>
		<if test="svyRi != null and svyRi != ''">	<![CDATA[ AND
			RI = #{svyRi} ]]>
		</if>
		<if test="svyJibun != null and svyJibun != ''">	<![CDATA[ AND
			JIBUN LIKE CONCAT('%', #{svyJibun}, '%') ]]>
		</if>
	</select>
	
	<!-- 대상지 계측장비 유무 조회 -->
	<select id="selectMseSensorEnnc" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO" resultMap="mseStripLandDetailVO">
		SELECT SLD_ID  
			, CASE WHEN SVY_MEMO::JSON->>'와이어신축계' IS NOT NULL THEN 'T' ELSE 'F' END AS TW_EN
		    , CASE WHEN SVY_MEMO::JSON->>'지중경사계' IS NOT NULL THEN 'T' ELSE 'F' END AS INC_EN
		    , CASE WHEN SVY_MEMO::JSON->>'지하수위계' IS NOT NULL THEN 'T' ELSE 'F' END AS WL_EN
		    , CASE WHEN SVY_MEMO::JSON->>'강우계' IS NOT NULL THEN 'T' ELSE 'F' END AS RG_EN
		    , CASE WHEN SVY_MEMO::JSON->>'구조물변위계' IS NOT NULL THEN 'T' ELSE 'F' END AS TM_EN
		    , CASE WHEN SVY_MEMO::JSON->>'지표변위계' IS NOT NULL THEN 'T' ELSE 'F' END AS SD_EN
		    , CASE WHEN SVY_MEMO::JSON->>'GPS변위계' IS NOT NULL THEN 'T' ELSE 'F' END AS GPS_EN
		    , CASE WHEN SVY_MEMO::JSON->>'게이트웨이' IS NOT NULL THEN 'T' ELSE 'F' END AS GATEWAY_EN
		    , CASE WHEN SVY_MEMO::JSON->>'노드' IS NOT NULL THEN 'T' ELSE 'F' END AS NODE_EN
		FROM TN_FEIS_MSE_SLDINFO 
		WHERE SLD_ID = #{sldId}
	</select>
	
	<select id="selectMseSldDetail" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO" resultMap="mseStripLandDetailVO">
		 SELECT SLD_ID
			, SD
			, SGG
			, EMD
			, RI
			, JIBUN
			, OWNER
			, LGL_LIMIT 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'와이어신축계') AS WIRE_EXT 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'지하수위계') AS GW_GAUGE 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'강우계') AS RAIN_GAUGE 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'구조물변위계') AS STRC_DPM 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'지표변위계') AS SUR_DPM 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'GPS변위계') AS GPS_GAUGE 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'게이트웨이') AS GATEWAY 
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'노드') AS NODE
			, JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'지중경사계'->'외관점검') AS LIC_CNT
			, COALESCE(JSON_ARRAY_LENGTH(SVY_MEMO::JSON->'지중경사계'->'성능점검'),2) AS LIC_METER_CNT 
		FROM TN_FEIS_MSE_SLDINFO
		WHERE SLD_ID = #{sldId}
	</select>
	
	<!-- 대상지 통신모뎀번호 및 이동전화번호 목록 조회 -->
	<select id="selectMseSldModemCellNumList" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO" resultMap="mseStripLandDetailVO">
		SELECT KEY_ELEMENT.KEY AS GATEWAY_ID
		    , (KEY_ELEMENT.VALUE::JSONB->>0)::TEXT AS MODEM_NUM
		    , (KEY_ELEMENT2.VALUE::JSONB->>0)::TEXT AS CELL_NUM
		FROM (
		    SELECT JSONB_ARRAY_ELEMENTS(SVY_MEMO::JSONB->'통신모뎀번호') AS VALUE,
		    JSONB_ARRAY_ELEMENTS(SVY_MEMO::JSONB->'이동전화번호') AS VALUE2
		    FROM TN_FEIS_MSE_SLDINFO
		    WHERE SLD_ID = #{sldId}
		) AS SUBQUERY,
		LATERAL JSONB_EACH(VALUE) AS KEY_ELEMENT, 
		lateral JSONB_EACH(VALUE2) AS KEY_ELEMENT2
	</select>
	
	<!-- 대상지 지중경사계 목록 조회 -->
	<select id="selectMseSldLicMeterList" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO" resultType="egovMap">
		SELECT LIC_ID
		    , STRING_AGG(LIC::TEXT, ',') AS LIC_HG_LIST
		FROM (
		    SELECT DISTINCT SPLIT_PART(LIC->>'채널명','(',1) AS LIC_ID
		        , REGEXP_REPLACE(SPLIT_PART(LIC->>'채널명','(',2),'[^0-9.]','','g')::FLOAT AS LIC
		    FROM TN_FEIS_MSE_SLDINFO 
		        , JSON_ARRAY_ELEMENTS(SVY_MEMO::JSON->'지중경사계'->'성능점검') AS LIC
		    WHERE SLD_ID = #{sldId}
		    ORDER BY LIC ASC
		) AS SUBQUERY
		GROUP BY LIC_ID
		ORDER BY LIC_ID ASC
	</select>
	
	<!-- 대상지 등록 -->	
	<insert id="insertMseSld" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO">
		INSERT INTO TN_FEIS_MSE_SLDINFO
		(
			SLD_ID
			, SD
			, SGG
			, EMD
			, RI
			, JIBUN
			, OWNER
			, LGL_LIMIT
			, SVY_LON
			, SVY_LAT
			, SVY_DATA
			, PNUCODE
			, SVY_MEMO
		)
		VALUES(
			#{sldId}
			, #{svySd}
			, #{svySgg}
			, #{svyEmd}
			, #{svyRi}
			, #{svyJibun}
			, #{owner}
			, #{lglLimit}
			, #{svyLon}
			, #{svyLat}
			, #{svyData}
			, #{pnucode}
			, 
			<![CDATA[ CONCAT('{' ]]>
				<if test="svySd != null">
	    		<![CDATA[ ,CONCAT('"시도" : "',#{svySd},'",')]]>
	        	</if>
				<if test="svySgg != null">
	    		<![CDATA[ ,CONCAT('"시군구" : "',#{svySgg},'",')]]>
	        	</if>
				<if test="svyEmd != null">
	    		<![CDATA[ ,CONCAT('"읍면동" : "',#{svyEmd},'",')]]>
	        	</if>
				<if test="svyRi != null">
	    		<![CDATA[ ,CONCAT('"리" : "',#{svyRi},'",')]]>
	        	</if>
				<if test="svyJibun != null">
	    		<![CDATA[ ,CONCAT('"지번" : "',#{svyJibun},'",')]]>
	        	</if>
				<if test="wireExt != null and wireExt !=''">
	    		<![CDATA[ ,CONCAT('"와이어신축계" : ',#{wireExt},',')]]>
	        	</if>
				<if test="licMeter != null and licMeter !=''">
					<choose>
						<when test="licMeterPerCheck != null and licMeterPerCheck !=''">
			    			<![CDATA[ ,CONCAT('"지중경사계" : {"외관점검" : ',#{licMeter},',')]]>
				    		<![CDATA[ ,CONCAT('"성능점검" : ',#{licMeterPerCheck},'},')]]>
						</when>
						<otherwise>
							<![CDATA[ ,CONCAT('"지중경사계" : {"외관점검" : ',#{licMeter},'},')]]>
						</otherwise>
					</choose>
	        	</if>
				<if test="gwGauge != null and gwGauge !=''">
	    		<![CDATA[ ,CONCAT('"지하수위계" : ',#{gwGauge},',')]]>
	        	</if>
				<if test="rainGauge != null and rainGauge !=''">
	    		<![CDATA[ ,CONCAT('"강우계" : ',#{rainGauge},',')]]>
	        	</if>
				<if test="strcDpm != null and strcDpm !=''">
	    		<![CDATA[ ,CONCAT('"구조물변위계" : ',#{strcDpm},',')]]>
	        	</if>
				<if test="surDpm != null and surDpm !=''">
	    		<![CDATA[ ,CONCAT('"지표변위계" : ',#{surDpm},',')]]>
	        	</if>
				<if test="gpsGauge != null and gpsGauge !=''">
	    		<![CDATA[ ,CONCAT('"GPS변위계" : ',#{gpsGauge},',')]]>
	        	</if>
				<if test="gateway != null and gateway !=''">
	    		<![CDATA[ ,CONCAT('"게이트웨이" : ',#{gateway},',')]]>
	        	</if>
				<if test="node != null and node !=''">
	    		<![CDATA[ ,CONCAT('"노드" : ',#{node},',')]]>
	        	</if>
				<if test="modemNum != null and modemNum !=''">
	    		<![CDATA[ ,CONCAT('"통신모뎀번호" : ',#{modemNum},',')]]>
	        	</if>
				<if test="cellNum != null and cellNum !=''">
	    		<![CDATA[ ,CONCAT('"이동전화번호" : ',#{cellNum},',')]]>
	        	</if>
				<![CDATA[ ,CONCAT('"조사유형" : "계측장비"')]]>
		        
			<![CDATA[  ,'}') ]]>
		)
	</insert>
	
	<!-- pnu_code 조회 -->
	<select id="selectPnuCode" resultType="egovMap">
		SELECT A1 AS PNUCODE
			, ST_X(ST_CENTROID(SMGEOMETRY)) AS SVY_LON
			, ST_Y(ST_CENTROID(SMGEOMETRY)) AS SVY_LAT
			, ST_ASTEXT(ST_CENTROID(SMGEOMETRY)) AS SVY_DATA
		FROM TF_FEIS_LGSTR
		WHERE 1 = 1
		<if test="svyEmd != null and svyEmd !=''">
		<![CDATA[ AND A2 LIKE CONCAT(#{svyEmd}, '%') ]]>
		</if>
		<if test="svyRi != null and svyRi !=''">
		<![CDATA[ AND A2 = #{svyRi} ]]>
		</if>			
		<if test="svyJibun != null and svyJibun !=''">
		<![CDATA[ 
			AND (REPLACE(A4,' ','') = REGEXP_REPLACE(#{svyJibun},'[가-힣\s]','','g') OR REPLACE(A5,' ','') LIKE CONCAT(REPLACE(#{svyJibun},' ',''), '%')) 
		]]>
		</if>
		<![CDATA[
			LIMIT 1
		]]>
	</select>
	
	<!-- 대상지 수정 -->	
	<update id="updateMseSld" parameterType="or.sabang.sys.fck.mse.service.FckMseStripLandVO">
		<![CDATA[
			UPDATE TN_FEIS_MSE_SLDINFO
				SET LAST_UPDT_PNTTM = NOW()
					, SD = #{svySd}
					, SGG = #{svySgg}
					, EMD = #{svyEmd}
					, RI = #{svyRi}
					, JIBUN = #{svyJibun}
					, OWNER = #{owner}
					, LGL_LIMIT = #{lglLimit}
					, SVY_MEMO = (COALESCE(NULLIF(REPLACE(SVY_MEMO,'\\','\'),''),'{}'))::JSONB || CONCAT('{',
		]]>
		<if test="svySd != null">
   		<![CDATA[ CONCAT('"시도" : "',#{svySd},'",')]]>
       	</if>
		<if test="svySgg != null">
   		<![CDATA[ ,CONCAT('"시군구" : "',#{svySgg},'",')]]>
       	</if>
		<if test="svyEmd != null">
   		<![CDATA[ ,CONCAT('"읍면동" : "',#{svyEmd},'",')]]>
       	</if>
		<if test="svyRi != null">
   		<![CDATA[ ,CONCAT('"리" : "',#{svyRi},'",')]]>
       	</if>
		<if test="svyJibun != null">
   		<![CDATA[ ,CONCAT('"지번" : "',#{svyJibun},'",')]]>
       	</if>
		<if test="wireExt != null and wireExt !=''">
   		<![CDATA[ ,CONCAT('"와이어신축계" : ',#{wireExt},',')]]>
       	</if>
		<if test="licMeter != null and licMeter !=''">
			<choose>
				<when test="licMeterPerCheck != null and licMeterPerCheck !=''">
	    			<![CDATA[ ,CONCAT('"지중경사계" : {"외관점검" : ',#{licMeter},',')]]>
		    		<![CDATA[ ,CONCAT('"성능점검" : ',#{licMeterPerCheck},'},')]]>
				</when>
				<otherwise>
					<![CDATA[ ,CONCAT('"지중경사계" : {"외관점검" : ',#{licMeter},'},')]]>
				</otherwise>
			</choose>
       	</if>
		<if test="gwGauge != null and gwGauge !=''">
   		<![CDATA[ ,CONCAT('"지하수위계" : ',#{gwGauge},',')]]>
       	</if>
		<if test="rainGauge != null and rainGauge !=''">
   		<![CDATA[ ,CONCAT('"강우계" : ',#{rainGauge},',')]]>
       	</if>
		<if test="strcDpm != null and strcDpm !=''">
   		<![CDATA[ ,CONCAT('"구조물변위계" : ',#{strcDpm},',')]]>
       	</if>
		<if test="surDpm != null and surDpm !=''">
   		<![CDATA[ ,CONCAT('"지표변위계" : ',#{surDpm},',')]]>
       	</if>
		<if test="gpsGauge != null and gpsGauge !=''">
   		<![CDATA[ ,CONCAT('"GPS변위계" : ',#{gpsGauge},',')]]>
       	</if>
		<if test="gateway != null and gateway !=''">
   		<![CDATA[ ,CONCAT('"게이트웨이" : ',#{gateway},',')]]>
       	</if>
		<if test="node != null and node !=''">
   		<![CDATA[ ,CONCAT('"노드" : ',#{node},',')]]>
       	</if>
		<if test="modemNum != null and modemNum !=''">
   		<![CDATA[ ,CONCAT('"통신모뎀번호" : ',#{modemNum},',')]]>
       	</if>
		<if test="cellNum != null and cellNum !=''">
   		<![CDATA[ ,CONCAT('"이동전화번호" : ',#{cellNum},',')]]>
       	</if>
		<![CDATA[ ,CONCAT('"조사유형" : "계측장비"')]]>
		<![CDATA[
		,'}')::JSONB
             WHERE SLD_ID = #{sldId}
          ]]>
	</update>
	
	<!-- 대상지 삭제 -->
	<delete id="deleteMseSld" >
		<![CDATA[
			DELETE FROM TN_FEIS_MSE_SLDINFO
             WHERE SLD_ID = #{sldId}
		]]>	 
	</delete>
</mapper>